<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Professional Resume Builder - Create ATS-Friendly Resumes</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #667eea 100%);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
            min-height: 100vh;
            color: #2d3748;
        }

        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            min-height: 100vh;
            display: grid;
            grid-template-rows: auto 1fr;
        }

        /* Header */
        .header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            padding: 1rem 2rem;
            text-align: center;
            color: white;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header h1 {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .header p {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-bottom: 0.75rem;
        }

        .progress-container {
            max-width: 600px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50px;
            padding: 4px;
            overflow: hidden;
        }

        .progress-bar {
            height: 12px;
            background: linear-gradient(90deg, #10b981, #34d399, #6ee7b7);
            border-radius: 50px;
            width: 0%;
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 10px rgba(16, 185, 129, 0.4);
        }

        /* Main Layout */
        .main {
            display: grid;
            grid-template-columns: 550px 1fr;
            gap: 2rem;
            padding: 2rem;
            min-height: calc(100vh - 200px);
        }

        /* Left Panel (Form) */
        .left-panel {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 2rem;
            backdrop-filter: blur(20px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            height: fit-content;
            max-height: calc(100vh - 250px);
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .section-card {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(103, 126, 234, 0.1);
            position: relative;
            overflow: hidden;
        }

        .section-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2);
        }

        .section-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: #4a5568;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        label {
            display: block;
            font-size: 0.875rem;
            font-weight: 600;
            color: #4a5568;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }

        input, textarea, select {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: #f8fafc;
            font-family: inherit;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            transform: translateY(-1px);
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        /* Buttons */
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.025em;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6);
        }

        .btn-enhance {
            background: linear-gradient(135deg, #f59e0b, #fbbf24);
            color: white;
            padding: 0.5rem 1rem;
            font-size: 0.8rem;
        }

        .btn-enhance:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(245, 158, 11, 0.6);
        }

        .btn-add {
            background: linear-gradient(135deg, #10b981, #34d399);
            color: white;
            padding: 0.5rem 1rem;
            font-size: 0.8rem;
        }

        .btn-remove {
            background: linear-gradient(135deg, #ef4444, #f87171);
            color: white;
            padding: 0.4rem 0.8rem;
            font-size: 0.75rem;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.9);
            color: #4a5568;
            border: 2px solid #e2e8f0;
        }

        .section-controls {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .enhance-section {
            margin-top: 1rem;
            text-align: center;
        }

        .controls {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin-top: 2rem;
        }

        /* Dynamic Lists */
        .dynamic-item {
            background: #f7fafc;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            position: relative;
            transition: all 0.3s ease;
        }

        .dynamic-item:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .item-title {
            font-weight: 600;
            color: #2d3748;
        }

        /* Right Panel (Preview) */
        .right-panel {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            backdrop-filter: blur(20px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            overflow: hidden;
        }

        .template-switcher {
            background: linear-gradient(135deg, #667eea, #764ba2);
            padding: 1.5rem;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .template-switcher h2 {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .template-selector {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.9);
            color: #4a5568;
            font-weight: 600;
            cursor: pointer;
        }

        .preview-container {
            padding: 2rem;
            min-height: 600px;
            background: white;
            position: relative;
            max-height: calc(100vh - 300px);
            overflow-y: auto;
        }

        /* Resume Templates */
        .resume-template {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .resume-template.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Modern Template */
        .modern-header {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 2rem;
            text-align: center;
            margin: -2rem -2rem 2rem -2rem;
            border-radius: 0;
        }

        .modern-header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .modern-header .contact-info {
            font-size: 1rem;
            opacity: 0.9;
        }

        /* Professional Template */
        .professional-header {
            border-bottom: 3px solid #667eea;
            padding-bottom: 1rem;
            margin-bottom: 2rem;
        }

        .professional-header h1 {
            font-size: 2.2rem;
            color: #2d3748;
            margin-bottom: 0.5rem;
        }

        /* Resume Sections */
        .resume-section {
            margin-bottom: 2rem;
        }

        .resume-section h2 {
            color: #4a5568;
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #667eea;
        }

        .experience-item, .education-item, .project-item {
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #e2e8f0;
        }

        .experience-item:last-child, .education-item:last-child, .project-item:last-child {
            border-bottom: none;
        }

        .item-header-preview {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.5rem;
        }

        .item-title-preview {
            font-weight: 700;
            color: #2d3748;
            font-size: 1.1rem;
        }

        .item-company {
            color: #667eea;
            font-weight: 600;
        }

        .item-date {
            color: #718096;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .item-description {
            color: #4a5568;
            line-height: 1.6;
            margin-top: 0.5rem;
        }

        .skills-container {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .skill-tag {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 25px;
            font-size: 0.875rem;
            font-weight: 500;
        }

        /* Empty States */
        .empty-state {
            text-align: center;
            padding: 2rem;
            color: #a0aec0;
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        /* Loading & Toast */
        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            max-width: 400px;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid #f3f4f6;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            margin-top: 1rem;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .loading-subtext {
            margin-top: 0.5rem;
            font-size: 0.9rem;
            color: #718096;
        }

        .toast {
            position: fixed;
            top: 2rem;
            right: 2rem;
            background: #10b981;
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            transform: translateX(400px);
            transition: transform 0.3s ease;
            z-index: 1001;
            max-width: 300px;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.error {
            background: #ef4444;
        }

        /* Enhancement Status */
        .enhancement-status {
            display: inline-flex;
            align-items: center;
            font-size: 0.75rem;
            margin-left: 0.5rem;
        }

        .status-enhanced {
            color: #10b981;
        }

        .status-processing {
            color: #f59e0b;
        }

        /* Responsive Design */
        @media (max-width: 1400px) {
            .main {
                grid-template-columns: 500px 1fr;
            }
        }

        @media (max-width: 1200px) {
            .main {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .left-panel {
                max-height: none;
                order: 2;
            }

            .right-panel {
                order: 1;
            }
        }

        @media (max-width: 768px) {
            .header {
                padding: 1rem;
            }

            .header h1 {
                font-size: 1.8rem;
            }

            .main {
                padding: 1rem;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .controls {
                flex-direction: column;
            }

            .section-controls {
                flex-direction: column;
                align-items: stretch;
            }
        }

        /* Auto-save indicator */
        .auto-save-indicator {
            position: fixed;
            bottom: 2rem;
            left: 2rem;
            background: rgba(16, 185, 129, 0.9);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 25px;
            font-size: 0.8rem;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .auto-save-indicator.show {
            opacity: 1;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <h1>Professional Resume Builder</h1>
            <p>Create stunning, ATS-friendly resumes with AI enhancement in minutes</p>
            <div class="progress-container">
                <div id="progressBar" class="progress-bar"></div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main">
            <!-- Left Panel - Form -->
            <div class="left-panel">
                <!-- Personal Information -->
                <div class="section-card">
                    <div class="section-controls">
                        <h3 class="section-title">Personal Information</h3>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="fullName">Full Name *</label>
                            <input type="text" id="fullName" placeholder="John Doe" required>
                        </div>
                        <div class="form-group">
                            <label for="email">Email *</label>
                            <input type="email" id="email" placeholder="john@example.com" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="phone">Phone</label>
                            <input type="tel" id="phone" placeholder="+1 (555) 123-4567">
                        </div>
                        <div class="form-group">
                            <label for="location">Location</label>
                            <input type="text" id="location" placeholder="New York, NY">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="linkedin">LinkedIn Profile</label>
                        <input type="url" id="linkedin" placeholder="linkedin.com/in/johndoe">
                    </div>
                    <div class="form-group">
                        <label for="summary">Professional Summary</label>
                        <textarea id="summary" placeholder="Brief summary of your professional background and key achievements..."></textarea>
                    </div>
                    <div class="enhance-section">
                        <button type="button" class="btn btn-enhance" onclick="enhanceSection('summary')" id="enhanceSummaryBtn">
                            âœ¨ AI Enhance Summary
                        </button>
                    </div>
                </div>

                <!-- Work Experience -->
                <div class="section-card">
                    <div class="section-controls">
                        <h3 class="section-title">Work Experience</h3>
                        <button type="button" class="btn btn-add" onclick="addExperience()">Add Experience</button>
                    </div>
                    <div id="experienceContainer">
                        <div class="empty-state">
                            <div class="empty-state-icon">ðŸ’¼</div>
                            <p>No work experience added yet</p>
                        </div>
                    </div>
                    <div class="enhance-section">
                        <button type="button" class="btn btn-enhance" onclick="enhanceAllExperience()" id="enhanceExpBtn">
                            âœ¨ AI Enhance All Experience
                        </button>
                    </div>
                </div>

                <!-- Education -->
                <div class="section-card">
                    <div class="section-controls">
                        <h3 class="section-title">Education</h3>
                        <button type="button" class="btn btn-add" onclick="addEducation()">Add Education</button>
                    </div>
                    <div id="educationContainer">
                        <div class="empty-state">
                            <div class="empty-state-icon">ðŸŽ“</div>
                            <p>No education added yet</p>
                        </div>
                    </div>
                    <div class="enhance-section">
                        <button type="button" class="btn btn-enhance" onclick="enhanceSection('education')" id="enhanceEduBtn">
                            âœ¨ AI Enhance Education
                        </button>
                    </div>
                </div>

                <!-- Skills -->
                <div class="section-card">
                    <div class="section-controls">
                        <h3 class="section-title">Skills</h3>
                    </div>
                    <div class="form-group">
                        <label for="skills">Skills (comma-separated)</label>
                        <textarea id="skills" placeholder="JavaScript, React, Node.js, Python, SQL, Git..."></textarea>
                    </div>
                    <div class="enhance-section">
                        <button type="button" class="btn btn-enhance" onclick="enhanceSection('skills')" id="enhanceSkillsBtn">
                            âœ¨ AI Enhance Skills
                        </button>
                    </div>
                </div>

                <!-- Projects -->
                <div class="section-card">
                    <div class="section-controls">
                        <h3 class="section-title">Projects</h3>
                    </div>
                    <div class="form-group">
                        <label for="projects">Projects</label>
                        <textarea id="projects" placeholder="Project 1: Description of your key project...&#10;Project 2: Another important project..."></textarea>
                    </div>
                    <div class="enhance-section">
                        <button type="button" class="btn btn-enhance" onclick="enhanceSection('projects')" id="enhanceProjectsBtn">
                            âœ¨ AI Enhance Projects
                        </button>
                    </div>
                </div>

                <!-- Controls -->
                <div class="controls">
                    <button type="button" class="btn btn-primary" onclick="downloadPDF()">Download PDF</button>
                    <button type="button" class="btn btn-secondary" onclick="saveData()">Save Progress</button>
                    <button type="button" class="btn btn-secondary" onclick="loadData()">Load Saved</button>
                    <button type="button" class="btn btn-secondary" onclick="clearAll()">Clear All</button>
                </div>
                
                <!-- Multi-step Resume Option -->
                <div style="margin-top: 2rem; text-align: center; padding: 1.5rem; background: rgba(255,255,255,0.1); border-radius: 16px; border: 1px solid rgba(255,255,255,0.2);">
                    <h3 style="color: #4a5568; margin-bottom: 1rem; font-size: 1.1rem;">Prefer a guided step-by-step approach?</h3>
                    <a href="/start" style="display:inline-block;background:#fff;color:#4a5568;border:2px solid #e2e8f0;padding:.75rem 1.5rem;border-radius:12px;text-decoration:none;font-weight:600;transition:all 0.3s ease;box-shadow:0 4px 15px rgba(0,0,0,0.1);">Start Multi-step Resume</a>
                </div>
            </div>

            <!-- Right Panel - Preview -->
            <div class="right-panel">
                <div class="template-switcher">
                    <h2>Resume Preview</h2>
                    <select id="templateSelect" class="template-selector" onchange="switchTemplate()">
                        <option value="modern">Modern Template</option>
                        <option value="professional">Professional Template</option>
                        <option value="normal">normal</option>
                    </select>
                </div>

                <div class="preview-container">
                    <!-- Modern Template -->
                    <div id="modernTemplate" class="resume-template active">
                        <div class="modern-header">
                            <h1 id="modernName">Your Name</h1>
                            <div id="modernContact" class="contact-info"></div>
                        </div>

                        <div id="modernSummary" class="resume-section" style="display:none;">
                            <h2>Professional Summary</h2>
                            <p id="modernSummaryText"></p>
                        </div>

                        <div id="modernExperience" class="resume-section" style="display:none;">
                            <h2>Work Experience</h2>
                            <div id="modernExperienceContent"></div>
                        </div>

                        <div id="modernEducation" class="resume-section" style="display:none;">
                            <h2>Education</h2>
                            <div id="modernEducationContent"></div>
                        </div>

                        <div id="modernSkills" class="resume-section" style="display:none;">
                            <h2>Skills</h2>
                            <div id="modernSkillsContent" class="skills-container"></div>
                        </div>

                        <div id="modernProjects" class="resume-section" style="display:none;">
                            <h2>Projects</h2>
                            <div id="modernProjectsContent"></div>
                        </div>
                    </div>

                    <!-- Professional Template -->
                    <div id="professionalTemplate" class="resume-template">
                        <div class="professional-header">
                            <h1 id="professionalName">Your Name</h1>
                            <div id="professionalContact" class="contact-info"></div>
                        </div>

                        <div id="professionalSummary" class="resume-section" style="display:none;">
                            <h2>Professional Summary</h2>
                            <p id="professionalSummaryText"></p>
                        </div>

                        <div id="professionalExperience" class="resume-section" style="display:none;">
                            <h2>Professional Experience</h2>
                            <div id="professionalExperienceContent"></div>
                        </div>

                        <div id="professionalEducation" class="resume-section" style="display:none;">
                            <h2>Education</h2>
                            <div id="professionalEducationContent"></div>
                        </div>

                        <div id="professionalSkills" class="resume-section" style="display:none;">
                            <h2>Core Competencies</h2>
                            <div id="professionalSkillsContent" class="skills-container"></div>
                        </div>

                        <div id="professionalProjects" class="resume-section" style="display:none;">
                            <h2>Key Projects</h2>
                            <div id="professionalProjectsContent"></div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <div class="loading-text">Enhancing your resume...</div>
            <div class="loading-subtext">AI is improving your content with professional language</div>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div id="toast" class="toast"></div>

    <!-- Auto-save Indicator -->
    <div id="autoSaveIndicator" class="auto-save-indicator">Auto-saved</div>

    <script>
        // Global state
        let resumeData = {
            personal: {
                fullName: '',
                email: '',
                phone: '',
                location: '',
                linkedin: '',
                summary: ''
            },
            experiences: [],
            education: [],
            skills: '',
            projects: ''
        };

        let experienceCounter = 0;
        let educationCounter = 0;
        let isEnhancing = false;

        // Utility functions
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type}`;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        function showLoading(show = true, message = 'Enhancing your resume...', subtext = 'AI is improving your content with professional language') {
            const overlay = document.getElementById('loadingOverlay');
            const loadingText = document.querySelector('.loading-text');
            const loadingSubtext = document.querySelector('.loading-subtext');

            if (loadingText) loadingText.textContent = message;
            if (loadingSubtext) loadingSubtext.textContent = subtext;

            overlay.style.display = show ? 'flex' : 'none';
        }

        function showAutoSaveIndicator() {
            const indicator = document.getElementById('autoSaveIndicator');
            indicator.classList.add('show');
            setTimeout(() => indicator.classList.remove('show'), 2000);
        }

        function updateProgress() {
            const requiredFields = [
                resumeData.personal.fullName,
                resumeData.personal.email,
                resumeData.personal.summary,
                resumeData.experiences.length > 0,
                resumeData.education.length > 0,
                resumeData.skills
            ];

            const completed = requiredFields.filter(Boolean).length;
            const percentage = (completed / requiredFields.length) * 100;
            document.getElementById('progressBar').style.width = `${percentage}%`;
        }

        // Enhanced AI Enhancement Functions
        async function enhanceSection(sectionName) {
            if (isEnhancing) {
                showToast('Please wait for current enhancement to complete', 'error');
                return;
            }

            let content = '';
            const button = document.getElementById(`enhance${sectionName.charAt(0).toUpperCase() + sectionName.slice(1)}Btn`);

            // Get content based on section
            switch (sectionName) {
                case 'summary':
                    content = document.getElementById('summary').value.trim();
                    break;
                case 'skills':
                    content = document.getElementById('skills').value.trim();
                    break;
                case 'projects':
                    content = document.getElementById('projects').value.trim();
                    break;
                case 'education':
                    content = getEducationContent();
                    break;
                case 'experience':
                    content = getExperienceContent();
                    break;
                default:
                    showToast('Invalid section', 'error');
                    return;
            }

            if (!content) {
                showToast('Please add some content to enhance', 'error');
                return;
            }

            try {
                isEnhancing = true;
                if (button) {
                    button.disabled = true;
                    button.innerHTML = 'Processing...';
                }

                showLoading(true, `Enhancing ${sectionName}...`, 'AI is analyzing and improving your content');

                const response = await fetch('/enhance', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        section: sectionName,
                        content: content
                    })
                });

                const result = await response.json();

                if (result.success) {
                    updateFormWithEnhancedContent(sectionName, result.enhanced_content);
                    updateResumeData();
                    showToast(`${sectionName.charAt(0).toUpperCase() + sectionName.slice(1)} enhanced successfully!`);
                } else {
                    showToast(result.error || 'Enhancement failed', 'error');
                }

            } catch (error) {
                console.error('Enhancement error:', error);
                showToast('Enhancement failed. Please check your connection.', 'error');
            } finally {
                isEnhancing = false;
                if (button) {
                    button.disabled = false;
                    button.innerHTML = `Enhance ${sectionName.charAt(0).toUpperCase() + sectionName.slice(1)}`;
                }
                showLoading(false);
            }
        }

        function getExperienceContent() {
            const experiences = [];
            document.querySelectorAll('#experienceContainer .dynamic-item').forEach(item => {
                const title = item.querySelector('.exp-title')?.value || '';
                const company = item.querySelector('.exp-company')?.value || '';
                const description = item.querySelector('.exp-description')?.value || '';

                if (title || company || description) {
                    experiences.push(`${title} at ${company}: ${description}`);
                }
            });
            return experiences.join('\n\n');
        }

        function getEducationContent() {
            const education = [];
            document.querySelectorAll('#educationContainer .dynamic-item').forEach(item => {
                const degree = item.querySelector('.edu-degree')?.value || '';
                const field = item.querySelector('.edu-field')?.value || '';
                const institution = item.querySelector('.edu-institution')?.value || '';
                const details = item.querySelector('.edu-details')?.value || '';

                if (degree || field || institution || details) {
                    education.push(`${degree} in ${field} from ${institution}. ${details}`);
                }
            });
            return education.join('\n\n');
        }

        function updateFormWithEnhancedContent(sectionName, enhancedContent) {
            switch (sectionName) {
                case 'summary':
                    document.getElementById('summary').value = enhancedContent;
                    break;
                case 'skills':
                    document.getElementById('skills').value = enhancedContent;
                    break;
                case 'projects':
                    document.getElementById('projects').value = enhancedContent;
                    break;
                case 'experience':
                    updateExperienceDescriptions(enhancedContent);
                    break;
                case 'education':
                    updateEducationDetails(enhancedContent);
                    break;
            }
        }

        function updateExperienceDescriptions(enhancedContent) {
            const experiences = enhancedContent.split('\n\n');
            const experienceItems = document.querySelectorAll('#experienceContainer .dynamic-item');

            experiences.forEach((exp, index) => {
                if (experienceItems[index]) {
                    const descriptionField = experienceItems[index].querySelector('.exp-description');
                    if (descriptionField) {
                        const colonIndex = exp.indexOf(':');
                        if (colonIndex !== -1) {
                            descriptionField.value = exp.substring(colonIndex + 1).trim();
                        } else {
                            descriptionField.value = exp;
                        }
                    }
                }
            });
        }

        function updateEducationDetails(enhancedContent) {
            const educationItems = enhancedContent.split('\n\n');
            const eduElements = document.querySelectorAll('#educationContainer .dynamic-item');

            educationItems.forEach((edu, index) => {
                if (eduElements[index]) {
                    const degreeEl = eduElements[index].querySelector('.edu-degree');
                    const fieldEl = eduElements[index].querySelector('.edu-field');
                    const institutionEl = eduElements[index].querySelector('.edu-institution');
                    const detailsEl = eduElements[index].querySelector('.edu-details');

                    // Pattern: "Degree in Field from Institution. Details"
                    const match = edu.match(/^\s*(.*?)\s+in\s+(.*?)\s+from\s+(.*?)\.?\s*(.*)$/i);
                    if (match) {
                        const [, degreeVal, fieldVal, institutionVal, detailsVal] = match;
                        if (degreeEl) degreeEl.value = degreeVal.trim();
                        if (fieldEl) fieldEl.value = fieldVal.trim();
                        if (institutionEl) institutionEl.value = institutionVal.trim();
                        if (detailsEl) detailsEl.value = detailsVal.trim();
                    } else {
                        // Fallback: if we cannot parse, append to details only
                        if (detailsEl) {
                            detailsEl.value = edu.trim();
                        }
                    }
                }
            });
        }

        // Experience management
        function addExperience() {
            experienceCounter++;
            const container = document.getElementById('experienceContainer');

            // Remove empty state
            const emptyState = container.querySelector('.empty-state');
            if (emptyState) emptyState.remove();

            const experienceDiv = document.createElement('div');
            experienceDiv.className = 'dynamic-item';
            experienceDiv.innerHTML = `
                <div class="item-header">
                    <h4 class="item-title">Experience ${experienceCounter}</h4>
                    <div style="display: flex; gap: 0.5rem;">
                        <button type="button" class="btn btn-remove" onclick="removeExperience(this)">Remove</button>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Job Title</label>
                        <input type="text" class="exp-title" placeholder="Software Engineer" onchange="updateExperienceData()">
                    </div>
                    <div class="form-group">
                        <label>Company</label>
                        <input type="text" class="exp-company" placeholder="Tech Corp" onchange="updateExperienceData()">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Start Date</label>
                        <input type="month" class="exp-start" onchange="updateExperienceData()">
                    </div>
                    <div class="form-group">
                        <label>End Date</label>
                        <input type="month" class="exp-end" onchange="updateExperienceData()">
                        <label style="margin-top: 0.5rem;">
                            <input type="checkbox" class="exp-current" onchange="toggleCurrentJob(this)"> Currently employed here
                        </label>
                    </div>
                </div>
                <div class="form-group">
                    <label>Job Description</label>
                    <textarea class="exp-description" placeholder="â€¢ Developed web applications using React and Node.js&#10;â€¢ Collaborated with cross-functional teams to deliver projects on time&#10;â€¢ Improved system performance by 40%" onchange="updateExperienceData()"></textarea>
                </div>
            `;

            container.appendChild(experienceDiv);
            resumeData.experiences.push({
                id: experienceCounter,
                title: '',
                company: '',
                startDate: '',
                endDate: '',
                current: false,
                description: ''
            });

            updatePreview();
        }

        async function enhanceSingleExperience(button) {
            if (isEnhancing) {
                showToast('Please wait for current enhancement to complete', 'error');
                return;
            }

            const experienceItem = button.closest('.dynamic-item');
            const title = experienceItem.querySelector('.exp-title').value;
            const company = experienceItem.querySelector('.exp-company').value;
            const description = experienceItem.querySelector('.exp-description').value;

            if (!title && !company && !description) {
                showToast('Please add some experience details to enhance', 'error');
                return;
            }

            const content = `${title} at ${company}: ${description}`;

            try {
                isEnhancing = true;
                button.disabled = true;
                button.innerHTML = 'Processing...';

                const response = await fetch('/enhance', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        section: 'experience',
                        content: content
                    })
                });

                const result = await response.json();

                if (result.success) {
                    const colonIndex = result.enhanced_content.indexOf(':');
                    if (colonIndex !== -1) {
                        experienceItem.querySelector('.exp-description').value = result.enhanced_content.substring(colonIndex + 1).trim();
                    } else {
                        experienceItem.querySelector('.exp-description').value = result.enhanced_content;
                    }
                    updateExperienceData();
                    showToast('Experience enhanced successfully!');
                } else {
                    showToast(result.error || 'Enhancement failed', 'error');
                }
            } catch (error) {
                showToast('Enhancement failed', 'error');
            } finally {
                isEnhancing = false;
                button.disabled = false;
                button.innerHTML = 'Enhance';
            }
        }

        function removeExperience(button) {
            const experienceItem = button.closest('.dynamic-item');
            const index = Array.from(experienceItem.parentNode.children).indexOf(experienceItem);

            if (index >= 0 && index < resumeData.experiences.length) {
                resumeData.experiences.splice(index, 1);
            }
            experienceItem.remove();

            // Show empty state if no experiences left
            const container = document.getElementById('experienceContainer');
            if (container.children.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ðŸ’¼</div>
                        <p>No work experience added yet</p>
                    </div>
                `;
            }

            updatePreview();
        }

        function updateExperienceData() {
            const experienceItems = document.querySelectorAll('#experienceContainer .dynamic-item');
            resumeData.experiences = [];

            experienceItems.forEach((item, index) => {
                const title = item.querySelector('.exp-title').value;
                const company = item.querySelector('.exp-company').value;
                const startDate = item.querySelector('.exp-start').value;
                const endDate = item.querySelector('.exp-end').value;
                const current = item.querySelector('.exp-current').checked;
                const description = item.querySelector('.exp-description').value;

                resumeData.experiences.push({
                    id: index + 1,
                    title,
                    company,
                    startDate,
                    endDate,
                    current,
                    description
                });
            });

            updatePreview();
            updateProgress();
        }

        function toggleCurrentJob(checkbox) {
            const endDateInput = checkbox.closest('.form-group').querySelector('.exp-end');
            endDateInput.disabled = checkbox.checked;
            if (checkbox.checked) {
                endDateInput.value = '';
            }
            updateExperienceData();
        }

        // Education management
        function addEducation() {
            educationCounter++;
            const container = document.getElementById('educationContainer');

            // Remove empty state
            const emptyState = container.querySelector('.empty-state');
            if (emptyState) emptyState.remove();

            const educationDiv = document.createElement('div');
            educationDiv.className = 'dynamic-item';
            educationDiv.innerHTML = `
                <div class="item-header">
                    <h4 class="item-title">Education ${educationCounter}</h4>
                    <button type="button" class="btn btn-remove" onclick="removeEducation(this)">Remove</button>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Degree</label>
                        <input type="text" class="edu-degree" placeholder="Bachelor of Science" onchange="updateEducationData()">
                    </div>
                    <div class="form-group">
                        <label>Field of Study</label>
                        <input type="text" class="edu-field" placeholder="Computer Science" onchange="updateEducationData()">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Institution</label>
                        <input type="text" class="edu-institution" placeholder="University Name" onchange="updateEducationData()">
                    </div>
                    <div class="form-group">
                        <label>Graduation Year</label>
                        <input type="number" class="edu-year" placeholder="2024" min="1950" max="2030" onchange="updateEducationData()">
                    </div>
                </div>
                <div class="form-group">
                    <label>Additional Details (GPA, Honors, etc.)</label>
                    <input type="text" class="edu-details" placeholder="GPA: 3.8/4.0, Magna Cum Laude" onchange="updateEducationData()">
                </div>
            `;

            container.appendChild(educationDiv);
            resumeData.education.push({
                id: educationCounter,
                degree: '',
                field: '',
                institution: '',
                year: '',
                details: ''
            });

            updatePreview();
        }

        function removeEducation(button) {
            const educationItem = button.closest('.dynamic-item');
            const index = Array.from(educationItem.parentNode.children).indexOf(educationItem);

            if (index >= 0 && index < resumeData.education.length) {
                resumeData.education.splice(index, 1);
            }
            educationItem.remove();

            // Show empty state if no education left
            const container = document.getElementById('educationContainer');
            if (container.children.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ðŸŽ“</div>
                        <p>No education added yet</p>
                    </div>
                `;
            }

            updatePreview();
        }

        function updateEducationData() {
            const educationItems = document.querySelectorAll('#educationContainer .dynamic-item');
            resumeData.education = [];

            educationItems.forEach((item, index) => {
                const degree = item.querySelector('.edu-degree').value;
                const field = item.querySelector('.edu-field').value;
                const institution = item.querySelector('.edu-institution').value;
                const year = item.querySelector('.edu-year').value;
                const details = item.querySelector('.edu-details').value;

                resumeData.education.push({
                    id: index + 1,
                    degree,
                    field,
                    institution,
                    year,
                    details
                });
            });

            updatePreview();
            updateProgress();
        }

        // Template switching
        function switchTemplate() {
            const templateSelect = document.getElementById('templateSelect');
            const selectedTemplate = templateSelect.value;

            // Hide all templates
            document.querySelectorAll('.resume-template').forEach(template => {
                template.classList.remove('active');
            });

            // Show selected template
            document.getElementById(`${selectedTemplate}Template`).classList.add('active');
            updatePreview();
        }

        // Update preview for all templates
        function updatePreview() {
            updatePersonalInfo();
            updateSummary();
            updateExperiences();
            updateEducationPreview();
            updateSkillsPreview();
            updateProjectsPreview();
        }

        function updatePersonalInfo() {
            const name = resumeData.personal.fullName || 'Your Name';
            const contactParts = [];

            if (resumeData.personal.email) contactParts.push(resumeData.personal.email);
            if (resumeData.personal.phone) contactParts.push(resumeData.personal.phone);
            if (resumeData.personal.location) contactParts.push(resumeData.personal.location);
            if (resumeData.personal.linkedin) contactParts.push(resumeData.personal.linkedin);

            const contactInfo = contactParts.join(' â€¢ ');

            // Update all templates
            ['modern', 'professional'].forEach(template => {
                document.getElementById(`${template}Name`).textContent = name;
                document.getElementById(`${template}Contact`).textContent = contactInfo;
            });
        }

        function updateSummary() {
            const summary = resumeData.personal.summary;

            ['modern', 'professional'].forEach(template => {
                const section = document.getElementById(`${template}Summary`);
                const text = document.getElementById(`${template}SummaryText`);

                if (summary) {
                    section.style.display = 'block';
                    text.textContent = summary;
                } else {
                    section.style.display = 'none';
                }
            });
        }

        function updateExperiences() {
            ['modern', 'professional'].forEach(template => {
                const section = document.getElementById(`${template}Experience`);
                const content = document.getElementById(`${template}ExperienceContent`);

                if (resumeData.experiences.length > 0) {
                    section.style.display = 'block';
                    content.innerHTML = resumeData.experiences.map(exp => {
                        const dateRange = exp.startDate ?
                            `${formatDate(exp.startDate)} - ${exp.current ? 'Present': (exp.endDate ? formatDate(exp.endDate) : '')}` : '';

                        return `
                            <div class="experience-item">
                                <div class="item-header-preview">
                                    <div>
                                        <div class="item-title-preview">${exp.title || 'Job Title'}</div>
                                        <div class="item-company">${exp.company || 'Company Name'}</div>
                                    </div>
                                    <div class="item-date">${dateRange}</div>
                                </div>
                                ${exp.description ? `<div class="item-description">${formatDescription(exp.description)}</div>` : ''}
                            </div>
                        `;
                    }).join('');
                } else {
                    section.style.display = 'none';
                }
            });
        }

        function updateEducationPreview() {
            ['modern', 'professional'].forEach(template => {
                const section = document.getElementById(`${template}Education`);
                const content = document.getElementById(`${template}EducationContent`);

                if (resumeData.education.length > 0) {
                    section.style.display = 'block';
                    content.innerHTML = resumeData.education.map(edu => {
                        const degreeField = [edu.degree, edu.field].filter(Boolean).join(' in ');

                        return `
                            <div class="education-item">
                                <div class="item-header-preview">
                                    <div>
                                        <div class="item-title-preview">${degreeField || 'Degree'}</div>
                                        <div class="item-company">${edu.institution || 'Institution'}</div>
                                        ${edu.details ? `<div style="color: #718096; font-size: 0.875rem;">${edu.details}</div>` : ''}
                                    </div>
                                    <div class="item-date">${edu.year || ''}</div>
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    section.style.display = 'none';
                }
            });
        }

        function updateSkillsPreview() {
            const skills = resumeData.skills ? resumeData.skills.split(',').map(s => s.trim()).filter(Boolean) : [];

            ['modern', 'professional'].forEach(template => {
                const section = document.getElementById(`${template}Skills`);
                const content = document.getElementById(`${template}SkillsContent`);

                if (skills.length > 0) {
                    section.style.display = 'block';
                    content.innerHTML = skills.map(skill => `<span class="skill-tag">${skill}</span>`).join('');
                } else {
                    section.style.display = 'none';
                }
            });
        }

        function updateProjectsPreview() {
            const projects = resumeData.projects ? resumeData.projects.split('\n').filter(Boolean) : [];

            ['modern', 'professional'].forEach(template => {
                const section = document.getElementById(`${template}Projects`);
                const content = document.getElementById(`${template}ProjectsContent`);

                if (projects.length > 0) {
                    section.style.display = 'block';
                    content.innerHTML = projects.map(project =>
                        `<div class="project-item" style="margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid #e2e8f0;">${project}</div>`
                    ).join('');
                } else {
                    section.style.display = 'none';
                }
            });
        }

        // Utility functions for formatting
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString + '-01');
            return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short' });
        }

        function formatDescription(description) {
            return description.split('\n').map(line =>
                line.trim().startsWith('â€¢') ? line : (line ? `â€¢ ${line}` : line)
            ).join('<br>');
        }

        // Event listeners for form inputs
        function initializeEventListeners() {
            const inputs = ['fullName', 'email', 'phone', 'location', 'linkedin', 'summary', 'skills', 'projects'];
            inputs.forEach(id => {
                document.getElementById(id).addEventListener('input', updateResumeData);
            });
        }

        function updateResumeData() {
            // Update personal data
            resumeData.personal.fullName = document.getElementById('fullName').value;
            resumeData.personal.email = document.getElementById('email').value;
            resumeData.personal.phone = document.getElementById('phone').value;
            resumeData.personal.location = document.getElementById('location').value;
            resumeData.personal.linkedin = document.getElementById('linkedin').value;
            resumeData.personal.summary = document.getElementById('summary').value;
            resumeData.skills = document.getElementById('skills').value;
            resumeData.projects = document.getElementById('projects').value;

            updatePreview();
            updateProgress();
        }

        // Data management
        function saveData() {
            try {
                const dataToSave = {
                    ...resumeData,
                    savedAt: new Date().toISOString()
                };
                const blob = new Blob([JSON.stringify(dataToSave, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `resume-data-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
                showToast('Resume data saved successfully!');
            } catch (error) {
                showToast('Error saving resume data', 'error');
            }
        }

        function loadData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const data = JSON.parse(e.target.result);
                            loadResumeData(data);
                            showToast('Resume data loaded successfully!');
                        } catch (error) {
                            showToast('Error loading resume data', 'error');
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }

        function loadResumeData(data) {
            resumeData = { ...data };

            // Update form fields
            document.getElementById('fullName').value = resumeData.personal.fullName || '';
            document.getElementById('email').value = resumeData.personal.email || '';
            document.getElementById('phone').value = resumeData.personal.phone || '';
            document.getElementById('location').value = resumeData.personal.location || '';
            document.getElementById('linkedin').value = resumeData.personal.linkedin || '';
            document.getElementById('summary').value = resumeData.personal.summary || '';
            document.getElementById('skills').value = resumeData.skills || '';
            document.getElementById('projects').value = resumeData.projects || '';

            // Rebuild experience items
            const expContainer = document.getElementById('experienceContainer');
            expContainer.innerHTML = '';
            experienceCounter = 0;

            if (resumeData.experiences && resumeData.experiences.length > 0) {
                resumeData.experiences.forEach(() => {
                    addExperience();
                });

                // Populate with data
                const expItems = document.querySelectorAll('#experienceContainer .dynamic-item');
                resumeData.experiences.forEach((exp, index) => {
                    if (expItems[index]) {
                        expItems[index].querySelector('.exp-title').value = exp.title || '';
                        expItems[index].querySelector('.exp-company').value = exp.company || '';
                        expItems[index].querySelector('.exp-start').value = exp.startDate || '';
                        expItems[index].querySelector('.exp-end').value = exp.endDate || '';
                        expItems[index].querySelector('.exp-current').checked = exp.current || false;
                        expItems[index].querySelector('.exp-description').value = exp.description || '';
                    }
                });
            } else {
                expContainer.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ðŸ’¼</div>
                        <p>No work experience added yet</p>
                    </div>
                `;
            }

            // Rebuild education items
            const eduContainer = document.getElementById('educationContainer');
            eduContainer.innerHTML = '';
            educationCounter = 0;

            if (resumeData.education && resumeData.education.length > 0) {
                resumeData.education.forEach(() => {
                    addEducation();
                });

                // Populate with data
                const eduItems = document.querySelectorAll('#educationContainer .dynamic-item');
                resumeData.education.forEach((edu, index) => {
                    if (eduItems[index]) {
                        eduItems[index].querySelector('.edu-degree').value = edu.degree || '';
                        eduItems[index].querySelector('.edu-field').value = edu.field || '';
                        eduItems[index].querySelector('.edu-institution').value = edu.institution || '';
                        eduItems[index].querySelector('.edu-year').value = edu.year || '';
                        eduItems[index].querySelector('.edu-details').value = edu.details || '';
                    }
                });
            } else {
                eduContainer.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ðŸŽ“</div>
                        <p>No education added yet</p>
                    </div>
                `;
            }

            updatePreview();
            updateProgress();
        }

        function clearAll() {
            if (confirm('Are you sure you want to clear all data? This action cannot be undone.')) {
                // Reset form
                document.querySelectorAll('input, textarea').forEach(field => field.value = '');

                // Reset containers
                document.getElementById('experienceContainer').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ðŸ’¼</div>
                        <p>No work experience added yet</p>
                    </div>
                `;

                document.getElementById('educationContainer').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ðŸŽ“</div>
                        <p>No education added yet</p>
                    </div>
                `;

                // Reset data
                resumeData = {
                    personal: { fullName: '', email: '', phone: '', location: '', linkedin: '', summary: '' },
                    experiences: [],
                    education: [],
                    skills: '',
                    projects: ''
                };

                experienceCounter = 0;
                educationCounter = 0;

                updatePreview();
                updateProgress();
                showToast('All data cleared');
            }
        }

        // PDF Generation
        function downloadPDF() {
            showLoading(true, 'Generating PDF...', 'Creating your professional resume document');

            const currentTemplate = document.getElementById('templateSelect').value;
            const templateElement = document.getElementById(`${currentTemplate}Template`);

            const options = {
                margin: 0.5,
                filename: `${resumeData.personal.fullName || 'resume'}-${currentTemplate}-template.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: {
                    scale: 2,
                    useCORS: true,
                    logging: false
                },
                jsPDF: {
                    unit: 'in',
                    format: 'a4',
                    orientation: 'portrait'
                }
            };

            html2pdf().from(templateElement).set(options).save().then(() => {
                showLoading(false);
                showToast('Resume downloaded successfully!');
            }).catch(error => {
                showLoading(false);
                showToast('Error generating PDF', 'error');
                console.error('PDF generation error:', error);
            });
        }

        // Auto-save functionality
        function autoSave() {
            if (resumeData.personal.fullName || resumeData.personal.email) {
                try {
                    const data = JSON.stringify(resumeData);
                    // Using a simple in-memory storage approach since localStorage is restricted
                    window.resumeBackup = data;
                    showAutoSaveIndicator();
                } catch (error) {
                    console.log('Auto-save failed:', error);
                }
            }
        }

        // Initialize the application
        function initializeApp() {
            initializeEventListeners();
            updatePreview();
            updateProgress();

            // Try to restore from backup if available
            try {
                if (window.resumeBackup) {
                    const data = JSON.parse(window.resumeBackup);
                    loadResumeData(data);
                    showToast('Previous session restored');
                }
            } catch (error) {
                console.log('No previous session found');
            }

            // Set up auto-save every 30 seconds
            setInterval(autoSave, 30000);
        }

        // Initialize app when DOM is loaded
        document.addEventListener('DOMContentLoaded', initializeApp);

        // Health check function
        async function checkHealth() {
            try {
                const response = await fetch('/health');
                const result = await response.json();

                if (!result.ollama_running) {
                    showToast('Warning: Ollama is not running. Enhancement features may not work.', 'error');
                } else if (!result.gemma_available) {
                    showToast('Warning: Gemma model not found. Please install it with: ollama pull gemma2:2b', 'error');
                }
            } catch (error) {
                console.log('Health check failed:', error);
            }
        }

        // Run health check on startup
        setTimeout(checkHealth, 2000);

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Ctrl/Cmd + S to save
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                saveData();
            }

            // Ctrl/Cmd + Enter to download PDF
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                e.preventDefault();
                downloadPDF();
            }
        });

        // Enhanced All Experience function
        async function enhanceAllExperience() {
            const experienceItems = document.querySelectorAll('#experienceContainer .dynamic-item');

            if (experienceItems.length === 0) {
                showToast('Please add some work experience first', 'error');
                return;
            }

            if (isEnhancing) {
                showToast('Please wait for current enhancement to complete', 'error');
                return;
            }

            try {
                isEnhancing = true;
                const button = document.getElementById('enhanceExpBtn');
                if (button) {
                    button.disabled = true;
                    button.innerHTML = 'Processing...';
                }

                showLoading(true, 'Enhancing all work experiences...', 'This may take a few moments');

                let enhancedCount = 0;

                for (let i = 0; i < experienceItems.length; i++) {
                    const item = experienceItems[i];
                    const title = item.querySelector('.exp-title').value;
                    const company = item.querySelector('.exp-company').value;
                    const description = item.querySelector('.exp-description').value;

                    if (title || company || description) {
                        const content = `${title} at ${company}: ${description}`;

                        try {
                            const response = await fetch('/enhance', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({
                                    section: 'experience',
                                    content: content
                                })
                            });

                            const result = await response.json();

                            if (result.success) {
                                const colonIndex = result.enhanced_content.indexOf(':');
                                if (colonIndex !== -1) {
                                    item.querySelector('.exp-description').value = result.enhanced_content.substring(colonIndex + 1).trim();
                                } else {
                                    item.querySelector('.exp-description').value = result.enhanced_content;
                                }
                                enhancedCount++;
                            }

                            // Small delay between requests to avoid overwhelming the server
                            await new Promise(resolve => setTimeout(resolve, 1000));

                        } catch (error) {
                            console.error(`Failed to enhance experience ${i + 1}:`, error);
                        }
                    }
                }

                updateExperienceData();
                showToast(`Enhanced ${enhancedCount} work experience(s) successfully!`);

            } catch (error) {
                console.error('Enhancement error:', error);
                showToast('Enhancement failed. Please try again.', 'error');
            } finally {
                isEnhancing = false;
                const button = document.getElementById('enhanceExpBtn');
                if (button) {
                    button.disabled = false;
                    button.innerHTML = 'Enhance All';
                }
                showLoading(false);
            }
        }

        // Form validation
        function validateForm() {
            const errors = [];

            if (!resumeData.personal.fullName.trim()) {
                errors.push('Full name is required');
            }

            if (!resumeData.personal.email.trim()) {
                errors.push('Email is required');
            } else if (!isValidEmail(resumeData.personal.email)) {
                errors.push('Please enter a valid email address');
            }

            if (resumeData.experiences.length === 0) {
                errors.push('At least one work experience is recommended');
            }

            return errors;
        }

        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        // Enhanced PDF download with validation
        function downloadPDF() {
            const errors = validateForm();

            if (errors.length > 0) {
                const proceed = confirm(`Your resume has some issues:\n\n${errors.join('\n')}\n\nDo you want to download anyway?`);
                if (!proceed) return;
            }

            showLoading(true, 'Generating PDF...', 'Creating your professional resume document');

            const currentTemplate = document.getElementById('templateSelect').value;
            const templateElement = document.getElementById(`${currentTemplate}Template`);

            const options = {
                margin: 0.5,
                filename: `${resumeData.personal.fullName || 'resume'}-${currentTemplate}-template.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: {
                    scale: 2,
                    useCORS: true,
                    logging: false
                },
                jsPDF: {
                    unit: 'in',
                    format: 'a4',
                    orientation: 'portrait'
                }
            };

            html2pdf().from(templateElement).set(options).save().then(() => {
                showLoading(false);
                showToast('Resume downloaded successfully!');
            }).catch(error => {
                showLoading(false);
                showToast('Error generating PDF', 'error');
                console.error('PDF generation error:', error);
            });
        }

        // Word count and character limit helpers
        function updateCharacterCount(textareaId, maxLength = 500) {
            const textarea = document.getElementById(textareaId);
            const currentLength = textarea.value.length;

            // Add visual indicator if over limit
            if (currentLength > maxLength) {
                textarea.style.borderColor = '#ef4444';
                showToast(`${textareaId} is too long (${currentLength}/${maxLength} characters)`, 'error');
            } else {
                textarea.style.borderColor = '#e2e8f0';
            }
        }

        // Add character count listeners
        document.addEventListener('DOMContentLoaded', function() {
            const textareas = ['summary', 'skills', 'projects'];
            textareas.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('input', () => updateCharacterCount(id));
                }
            });
        });
    </script>
</body>
</html>